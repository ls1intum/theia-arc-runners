# ==============================================================================
# ARC Runner Scale Set - Stateless (Organization Level)
# ==============================================================================
# This configuration deploys runners available to the ENTIRE Organization.
# ==============================================================================

githubConfigUrl: "https://github.com/ls1intum"
githubConfigSecret: github-arc-secret

minRunners: 2
maxRunners: 30

template:
  spec:
    containers:
      - name: runner
        image: ghcr.io/actions/actions-runner:latest
        command: ["bash", "-c", "echo 'Waiting for Docker...'; for i in {1..60}; do if docker info >/dev/null 2>&1; then break; fi; sleep 1; done; /home/runner/run.sh"]
        env:
          - name: DOCKER_HOST
            value: unix:///var/run/docker.sock
        resources:
          requests:
            cpu: 250m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 4Gi
        volumeMounts:
          - name: work
            mountPath: /home/runner/_work
          - name: dind-sock
            mountPath: /var/run

      - name: dind
        image: docker:dind
        args: ["dockerd", "--host=unix:///var/run/docker.sock", "--group=123"]
        securityContext:
          privileged: true
        resources:
          requests:
            cpu: 1000m
            memory: 2Gi
          limits:
            cpu: 8000m
            memory: 16Gi
        volumeMounts:
          - name: work
            mountPath: /home/runner/_work
          - name: dind-sock
            mountPath: /var/run
          - name: docker-storage
            mountPath: /var/lib/docker
          - name: dind-config
            mountPath: /etc/docker/daemon.json
            subPath: daemon.json

    volumes:
      - name: work
        emptyDir: {}
      - name: dind-sock
        emptyDir: {}
      - name: docker-storage
        emptyDir: {}
      - name: dind-config
        configMap:
          name: dind-daemon-config
